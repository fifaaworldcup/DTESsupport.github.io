<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vancouver DTES Lifeline Map</title>

  <!-- Icons (place /icons/icon-192.png and -512.png) -->
  <link rel="icon" href="/icons/icon-192.png" />

  <!-- Local vendor CSS -->
  <link rel="stylesheet" href="/libs/leaflet/leaflet.css" />
  <link rel="stylesheet" href="/libs/leaflet.markercluster/MarkerCluster.css" />
  <link rel="stylesheet" href="/libs/leaflet.markercluster/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="/libs/leaflet-routing-machine/leaflet-routing-machine.css" />

  <!-- Your compiled Tailwind / custom CSS -->
  <link rel="stylesheet" href="/css/tailwind.min.css" />

  <style>
    /* Simple custom dark styling complements Tailwind (override as needed) */
    html,body,#map { height:100%; }
    body { background:#000; color:#e6fff6; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .site-header { padding: 2rem; }
    .control-btn { border:1px solid #47F3C5; color:#47F3C5; background:transparent; padding:0.5rem 0.9rem; border-radius:999px; }
    .access-panel { position: fixed; left:1.5rem; bottom:2rem; z-index:1400; }
    .lang-select { background: #0b0b0b; color: #e6fff6; border:1px solid #8aefd6; padding:6px 10px; border-radius:8px; }
    .loader { position: absolute; inset:0; display:flex; align-items:center; justify-content:center; z-index:2000; background: rgba(0,0,0,0.75); }
  </style>
</head>
<body class="antialiased">

  <div id="loader" class="loader" aria-hidden="false">
    <div class="text-center">
      <h2 class="text-2xl">Loading resources…</h2>
      <p class="mt-2 text-sm">If this takes long, check console or network.</p>
    </div>
  </div>

  <header class="site-header max-w-6xl mx-auto">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-4xl font-bold">Vancouver DTES Lifeline Map</h1>
        <p class="text-sm opacity-80">Immediate access to food, shelters, harm reduction, and hotlines.</p>
      </div>

      <div class="flex items-center gap-3">
        <select id="languageSelect" class="lang-select" aria-label="Select language">
          <option value="en">English</option>
          <option value="ar">العربية</option>
          <option value="fa">فارسی</option>
          <option value="bn">বাংলা</option>
          <option value="hi">हिन्दी</option>
          <option value="ur">اردو</option>
          <option value="pa">ਪੰਜਾਬੀ</option>
          <option value="tl">Tagalog</option>
          <option value="zh">中文</option>
          <option value="es">Español</option>
          <option value="fr">Français</option>
          <option value="nl">Nederlands</option>
          <option value="it">Italiano</option>
          <option value="sv">Svenska</option>
        </select>

        <button id="listToggle" class="control-btn">List view</button>
        <button id="findMeBtn" class="control-btn">Find me</button>
        <button id="call911" class="control-btn">911</button>
      </div>
    </div>

    <div class="mt-6">
      <input id="searchBox" placeholder="Search by name, type, or service" aria-label="Search"
             class="w-full p-3 rounded-lg bg-black border border-green-300 text-white" />
    </div>
  </header>

  <main class="max-w-6xl mx-auto relative">
    <div id="map" style="height:70vh; border-radius:8px; overflow:hidden;"></div>
  </main>

  <!-- Accessibility panel -->
  <div class="access-panel">
    <div class="bg-black/60 p-4 rounded-lg">
      <h3 class="font-semibold mb-2">Accessibility</h3>
      <div class="flex gap-2 flex-wrap">
        <button id="toggleContrast" class="control-btn">High contrast</button>
        <button id="toggleDyslexic" class="control-btn">Dyslexic font</button>
        <button id="fontDec" class="control-btn">A-</button>
        <button id="fontInc" class="control-btn">A+</button>
        <button id="readPopup" class="control-btn">Read popup</button>
        <button id="minimizeAccess" class="control-btn">−</button>
      </div>
    </div>
  </div>

  <!-- List view (hidden by default) -->
  <aside id="listView" class="hidden fixed right-4 top-20 bg-black/80 rounded-lg p-4 w-96 max-h-[70vh] overflow-auto z-1400">
    <h4 class="font-semibold mb-2">List of resources</h4>
    <ul id="resourceList" class="space-y-2"></ul>
  </aside>

  <!-- Map legend + attribution -->
  <footer class="max-w-6xl mx-auto my-6 text-sm opacity-70">
    <div>Hotlines and support — translations available. Offline mode: core map and resources work; routing uses approximate straight-line directions when router is offline.</div>
  </footer>

  <!-- Vendor scripts (local) -->
  <script src="/libs/leaflet/leaflet.js"></script>
  <script src="/libs/leaflet.markercluster/leaflet.markercluster.min.js"></script>
  <script src="/libs/leaflet-routing-machine/leaflet-routing-machine.min.js"></script>
  <script src="/libs/qrcode/qrcode.min.js"></script>

  <!-- Your app script (markers + UI) -->
  <script src="/js/markers.js"></script>

  <!-- Service worker registration -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(err => console.warn('SW register failed', err));
    }
  </script>

  <!-- Inline small helper to wire language select to markers (markers.js exposes functions) -->
  <script>
    (function(){
      const langSelect = document.getElementById('languageSelect');
      // sync default language
      window.currentLanguage = window.currentLanguage || 'en';
      if (langSelect) {
        langSelect.value = window.currentLanguage;
        langSelect.addEventListener('change', () => {
          window.currentLanguage = langSelect.value;
          // markers.js exposes rebindTranslations()
          if (window.rebindTranslations) window.rebindTranslations(window.currentLanguage);
        });
      }

      // accessibility controls
      document.getElementById('toggleContrast').addEventListener('click', () => {
        document.body.classList.toggle('high-contrast');
      });
      document.getElementById('toggleDyslexic').addEventListener('click', () => {
        document.body.classList.toggle('dyslexic');
      });
      document.getElementById('fontInc').addEventListener('click', () => {
        const s = parseFloat(getComputedStyle(document.documentElement).fontSize) || 16;
        document.documentElement.style.fontSize = (s + 1) + 'px';
      });
      document.getElementById('fontDec').addEventListener('click', () => {
        const s = parseFloat(getComputedStyle(document.documentElement).fontSize) || 16;
        document.documentElement.style.fontSize = Math.max(12,s - 1) + 'px';
      });
      document.getElementById('readPopup').addEventListener('click', () => {
        if (window.readCurrentPopup) window.readCurrentPopup();
      });
      document.getElementById('minimizeAccess').addEventListener('click', (e) => {
        const panel = e.target.closest('.access-panel');
        if (panel) {
          panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
      });

      // list view toggle
      const listBtn = document.getElementById('listToggle');
      const listView = document.getElementById('listView');
      listBtn.addEventListener('click', () => {
        if (listView.classList.contains('hidden')) {
          listView.classList.remove('hidden');
        } else {
          listView.classList.add('hidden');
        }
      });

      // search
      const searchBox = document.getElementById('searchBox');
      searchBox.addEventListener('input', (e) => {
        if (window.filterResources) window.filterResources(e.target.value);
      });

      // find me
      document.getElementById('findMeBtn').addEventListener('click', () => {
        if (window.locateMe) window.locateMe();
      });

      // 911 button shortcut
      document.getElementById('call911').addEventListener('click', () => {
        alert('Call 911 in an emergency. On mobile the dialer will open (if allowed).');
        if (navigator.userAgent && /Mobi/.test(navigator.userAgent)) {
          window.location.href = 'tel:911';
        }
      });

    })();
  </script>

  <noscript>
    <div style="position:fixed;left:0;right:0;top:0;background:#ffefef;color:#360000;padding:8px;text-align:center;">
      JavaScript is required for full functionality.
    </div>
  </noscript>
</body>
</html>
